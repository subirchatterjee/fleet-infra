apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: grav-${tech_name}
  namespace: personal
  labels:
    app: grav-${tech_name}
spec:
  replicas: 1 # active nas
  selector:
    matchLabels:
      app: grav-${tech_name}
  serviceName: grav-${tech_name}
  template:
    metadata:
      annotations: {}
      labels:
        app: grav-${tech_name}
    spec:
      containers:
        - name: grav-${tech_name}
          image: dsavell/grav
          imagePullPolicy: Always
          # command: ["tail","-f","/dev/null"]
          env:
            - name: GRAV_MULTISITE
              value: subdirectory
          ports:
            - containerPort: 80
              name: grav-http
              protocol: TCP
          volumeMounts:
            - mountPath: "/var/www/grav"
              subPath: data
              name: grav-${tech_name}-data-nas
          resources:
            requests:
              cpu: 100m
            limits:
              memory: 256Mi
        - name: filebrowser
          image: filebrowser/filebrowser:v2
          args: ["-p","8000","-d","/db/database.db"]
          ports:
          - containerPort: 8000
            name: fb-http
            protocol: TCP
          env:
          - name: TZ
            value: America/New_York
          volumeMounts:
          - name: grav-${tech_name}-data-nas
            subPath: filebrowser
            mountPath: /db
          - name: grav-${tech_name}-data-nas
            subPath: data
            mountPath: /srv/server-data
      volumes:
        - name: grav-${tech_name}-data-nas
          persistentVolumeClaim:
            claimName: grav-${tech_name}-data-nas
      imagePullSecrets:
        - name: docker-hub
