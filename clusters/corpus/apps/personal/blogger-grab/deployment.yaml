apiVersion: apps/v1
kind: Deployment
metadata:
  name: &app blogger-grab
  namespace: personal
  labels:
    app: *app
spec:
  replicas: 36
  selector:
    matchLabels:
      app: *app
  template:
    metadata:
      labels:
        app: *app
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "PreferNoSchedule"
    spec:
      containers:
        - name: *app
          image: atdr.meo.ws/archiveteam/blogger-grab@sha256:70dcd07c6dd1b0f7e9de4f176f510a17b043603b3525ed24b2ec0373e1cf2504
          env:
            - name: SHARED_RSYNC_THREADS
              value: "2"
          command:
            - bash
            - -c
            - |
              sleep=$((1 + $RANDOM % 120))
              echo "sleeping $sleep"
              sleep $sleep
              run-pipeline3 \
              --disable-web-server \
              pipeline.py \
              --concurrent 20 \
              --disable-web-server \
              tyzbit
          volumeMounts:
            - mountPath: /grab/data
              name: cache-volume
      volumes:
        - name: cache-volume
          emptyDir:
            sizeLimit: 4096Mi
          imagePullPolicy: Always
      # nodeSelector:
      #   blogger-node: "true"
    # affinity:
    #   podAntiAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       - topologyKey: "kubernetes.io/hostname"
    #         labelSelector:
    #           matchExpressions:
    #             - key: app.kubernetes.io/name
    #               operator: In
    #               values:
    #                 - "plex"
    #                 - "plex-secondary"
